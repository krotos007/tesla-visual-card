## ===================================================================
## Tesla LB — Template Sensors
##
## COMO USAR:
## No configuration.yaml, adiciona:
##   template: !include tesla_lb_template.yaml
##
## OU se já tens "template:" no configuration.yaml, usa:
##   template:
##     - !include tesla_lb_template.yaml
## ===================================================================

- sensor:
    ## ----- Sensor Principal: Corrente disponível -----
    - name: "Tesla Dynamic Charging Amps"
      unique_id: tesla_dynamic_charging_amps
      unit_of_measurement: "A"
      icon: mdi:ev-station
      state: >
        {% set limit_a = states('input_number.tesla_lb_limite_disjuntor') | float(30) %}
        {% set max_user = states('input_number.tesla_lb_carro_max') | float(27) %}
        {% set min_a = 5 %}
        {% set bat_thr = states('input_number.tesla_lb_bat_threshold') | float(16) %}
        {% set v = 230 %}
        {% set emrg = states('input_number.tesla_lb_emergencia') | float(28) %}
        {% set m_normal = states('input_number.tesla_lb_margem_normal') | float(2) %}
        {% set m_trans = states('input_number.tesla_lb_margem_transicao') | float(4) %}
        {% set m_rede = states('input_number.tesla_lb_margem_rede') | float(5) %}

        {% set max_a = max_user %}

        {% set grid_w = states('sensor.quadro_casa_channel_2_power') | float(0) * -1 %}
        {% set car_w = states('sensor.carro_zoe_power') | float(0) %}
        {% set grid_a = grid_w / v %}
        {% set car_a = car_w / v %}

        {% set bat_soc = states('sensor.ss_battery_soc') | float(0) %}
        {% set bat_w = states('sensor.ss_battery_power') | float(0) %}
        {% set solar_w = (states('sensor.ss_pv1_power') | float(0)) + (states('sensor.ss_pv2_power') | float(0)) %}
        {% set ess_w = states('sensor.ss_essential_power') | float(0) %}
        {% set gct_w = states('sensor.ss_grid_ct_power') | float(0) %}

        {% set bat_out = bat_w > 0 %}
        {% set solar_ok = solar_w >= ess_w and solar_w > 50 %}
        {% set grid_on = (not bat_out) and (not solar_ok) and gct_w > 100 %}
        {% set bat_grid = bat_w < -50 and solar_w < 50 %}
        {% set risk = bat_soc > bat_thr and bat_soc <= bat_thr + 10 and bat_out %}
        {% set unsafe = grid_on or bat_grid %}

        {% if grid_a | abs >= emrg %}0
        {% else %}
          {% if unsafe %}{% set m = m_rede %}
          {% elif risk %}{% set m = m_trans %}
          {% else %}{% set m = m_normal %}{% endif %}

          {% set house_a = grid_a - car_a %}
          {% set avail = limit_a - house_a - m %}
          {% if avail > max_a %}{% set avail = max_a %}{% endif %}

          {% if unsafe and avail <= min_a %}0
          {% elif avail >= min_a %}{{ avail | int }}
          {% else %}0{% endif %}
        {% endif %}

      attributes:
        grid_raw_watts: "{{ states('sensor.quadro_casa_channel_2_power') | float(0) | round(0) }}"
        grid_import_watts: "{{ (states('sensor.quadro_casa_channel_2_power') | float(0) * -1) | round(0) }}"
        grid_import_amps: "{{ ((states('sensor.quadro_casa_channel_2_power') | float(0) * -1) / 230) | round(1) }}"
        car_watts: "{{ states('sensor.carro_zoe_power') | float(0) | round(0) }}"
        wallbox_on: "{{ is_state('switch.shellyplus1_10061cd36ce4_switch_0', 'on') }}"
        tesla_actual_amps: "{{ states('sensor.dream_charger_current_2') | float(0) }}"
        tesla_set_limit: "{{ states('number.dream_charge_current') | float(0) | int }}"
        tesla_state: "{{ states('sensor.dream_charging') }}"
        tesla_battery_pct: "{{ states('sensor.dream_battery_level') | float(0) }}"
        solar_watts: "{{ (states('sensor.ss_pv1_power') | float(0) + states('sensor.ss_pv2_power') | float(0)) | round(0) }}"
        battery_soc: "{{ states('sensor.ss_battery_soc') | float(0) }}"
        battery_watts: "{{ states('sensor.ss_battery_power') | float(0) | round(0) }}"
        essential_watts: "{{ states('sensor.ss_essential_power') | float(0) | round(0) }}"
        energy_source: >
          {% set bat_w = states('sensor.ss_battery_power') | float(0) %}
          {% set solar = (states('sensor.ss_pv1_power') | float(0)) + (states('sensor.ss_pv2_power') | float(0)) %}
          {% set ess = states('sensor.ss_essential_power') | float(0) %}
          {% set gct = states('sensor.ss_grid_ct_power') | float(0) %}
          {% if bat_w > 0 and solar > 50 %}Bateria+Solar
          {% elif bat_w > 0 %}Bateria
          {% elif solar >= ess and solar > 50 %}Solar
          {% elif bat_w < -50 and solar < 50 %}Rede (bat carrega)
          {% elif bat_w <= 0 and not (solar >= ess and solar > 50) and gct > 100 %}Rede
          {% else %}Misto{% endif %}
        safety_margin: >
          {% set bat_w = states('sensor.ss_battery_power') | float(0) %}
          {% set soc = states('sensor.ss_battery_soc') | float(0) %}
          {% set solar = (states('sensor.ss_pv1_power') | float(0)) + (states('sensor.ss_pv2_power') | float(0)) %}
          {% set ess = states('sensor.ss_essential_power') | float(0) %}
          {% set gct = states('sensor.ss_grid_ct_power') | float(0) %}
          {% set thr = states('input_number.tesla_lb_bat_threshold') | float(16) %}
          {% set grid_on = bat_w <= 0 and not (solar >= ess and solar > 50) and gct > 100 %}
          {% set bat_chrg = bat_w < -50 and solar < 50 %}
          {% set risk = soc > thr and soc <= thr + 10 and bat_w > 0 %}
          {% if grid_on or bat_chrg %}{{ states('input_number.tesla_lb_margem_rede') | float(5) }}
          {% elif risk %}{{ states('input_number.tesla_lb_margem_transicao') | float(4) }}
          {% else %}{{ states('input_number.tesla_lb_margem_normal') | float(2) }}{% endif %}
        emergency: >
          {{ ((states('sensor.quadro_casa_channel_2_power') | float(0) * -1) / 230) | abs >=
             states('input_number.tesla_lb_emergencia') | float(28) }}
        lb_active: "{{ is_state('input_boolean.tesla_lb_ativo', 'on') }}"

    ## ----- Sensor: Tempo Restante -----
    - name: "Tesla Tempo Restante"
      unique_id: tesla_tempo_restante
      unit_of_measurement: "h"
      icon: mdi:timer-sand
      state: >
        {% set cap = states('input_number.tesla_lb_bat_capacidade') | float(75) %}
        {% set pct = states('sensor.dream_battery_level') | float(0) %}
        {% set target = states('number.dream_charge_limit_2') | float(80) %}
        {% set car_w = states('sensor.carro_zoe_power') | float(0) %}
        {% set car_kw = car_w / 1000 %}
        {% set rest_kwh = cap * (target - pct) / 100 %}
        {% if car_kw > 0.1 and rest_kwh > 0 %}
          {{ (rest_kwh / car_kw) | round(1) }}
        {% else %}0{% endif %}
      attributes:
        remaining_kwh: >
          {% set cap = states('input_number.tesla_lb_bat_capacidade') | float(75) %}
          {% set pct = states('sensor.dream_battery_level') | float(0) %}
          {% set target = states('number.dream_charge_limit_2') | float(80) %}
          {{ (cap * (target - pct) / 100) | round(1) }}
        charging_kw_shelly: "{{ (states('sensor.carro_zoe_power') | float(0) / 1000) | round(1) }}"
        charging_kw_fleet: "{{ states('sensor.dream_charger_power_3') | float(0) }}"
