## ===================================================================
## Tesla LB â€” AutomaÃ§Ãµes
##
## COMO USAR (escolhe UMA opÃ§Ã£o):
##
## OPÃ‡ÃƒO 1 â€” Adicionar ao automations.yaml:
##   Cola o conteÃºdo (sem o "automation:") no ficheiro automations.yaml
##
## OPÃ‡ÃƒO 2 â€” Include separado no configuration.yaml:
##   automation lb: !include tesla_lb_automations.yaml
##
## OPÃ‡ÃƒO 3 â€” Criar via UI:
##   Settings â†’ Automations â†’ Create Automation â†’ Edit in YAML
##   Cola cada automaÃ§Ã£o individualmente
## ===================================================================

## ----- NÃ­vel 1: Ajustar corrente (debounce 10s, deadband configurÃ¡vel) -----
- alias: "Tesla LB - Ajustar Corrente"
  id: tesla_lb_adjust
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.tesla_dynamic_charging_amps
      for: "00:00:10"
  condition:
    - condition: state
      entity_id: input_boolean.tesla_lb_ativo
      state: "on"
    - condition: state
      entity_id: binary_sensor.dream_charge_cable
      state: "on"
    - condition: state
      entity_id: switch.shellyplus1_10061cd36ce4_switch_0
      state: "on"
    - condition: template
      value_template: >
        {% set new = states('sensor.tesla_dynamic_charging_amps') | int(0) %}
        {% set cur = states('number.dream_charge_current') | int(0) %}
        {% set db = states('input_number.tesla_lb_deadband') | int(2) %}
        {{ (new - cur) | abs >= db or new == 0 }}
  action:
    - choose:
        # PARAR
        - conditions:
            - condition: template
              value_template: "{{ states('sensor.tesla_dynamic_charging_amps') | int(0) == 0 }}"
          sequence:
            - service: button.press
              target:
                entity_id: button.dream_stop_charge
            - service: persistent_notification.create
              data:
                title: "ðŸ›‘ Tesla LB â€” Carregamento parado"
                message: >
                  Fonte: {{ state_attr('sensor.tesla_dynamic_charging_amps', 'energy_source') }}.
                  Grid: {{ state_attr('sensor.tesla_dynamic_charging_amps', 'grid_import_amps') }}A.
            - service: logbook.log
              data:
                name: "Tesla LB"
                message: >
                  ðŸ›‘ STOP â€” {{ state_attr('sensor.tesla_dynamic_charging_amps', 'energy_source') }}
      # AJUSTAR
      default:
        - service: number.set_value
          target:
            entity_id: number.dream_charge_current
          data:
            value: "{{ states('sensor.tesla_dynamic_charging_amps') }}"
        - service: logbook.log
          data:
            name: "Tesla LB"
            message: >
              ðŸ”„ {{ states('sensor.tesla_dynamic_charging_amps') }}A
              ({{ state_attr('sensor.tesla_dynamic_charging_amps', 'energy_source') }})

## ----- NÃ­vel 2: Kill Switch (Shelly corta wallbox) -----
- alias: "Tesla LB - Kill Switch"
  id: tesla_lb_emergency_kill
  mode: single
  trigger:
    - platform: template
      value_template: >
        {{ ((states('sensor.quadro_casa_channel_2_power') | float(0) * -1) / 230) | abs >=
           states('input_number.tesla_lb_emergencia') | float(28) }}
  condition:
    - condition: state
      entity_id: switch.shellyplus1_10061cd36ce4_switch_0
      state: "on"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.shellyplus1_10061cd36ce4_switch_0
    - service: persistent_notification.create
      data:
        title: "ðŸ›‘ EMERGÃŠNCIA â€” Wallbox cortada!"
        message: >
          Grid a {{ ((states('sensor.quadro_casa_channel_2_power') | float(0) * -1) / 230) | round(1) }}A!
          Limite: {{ states('input_number.tesla_lb_emergencia') }}A.
          Wallbox DESLIGADA. SerÃ¡ religada quando o grid estabilizar.
    - service: logbook.log
      data:
        name: "Tesla LB"
        message: "ðŸ›‘ KILL SWITCH!"

## ----- Religar wallbox (grid < metade do disjuntor por 2min) -----
- alias: "Tesla LB - Religar Wallbox"
  id: tesla_lb_restore
  mode: single
  trigger:
    - platform: template
      value_template: >
        {{ ((states('sensor.quadro_casa_channel_2_power') | float(0) * -1) / 230) | abs <
           (states('input_number.tesla_lb_limite_disjuntor') | float(30) / 2) }}
      for: "00:02:00"
  condition:
    - condition: state
      entity_id: switch.shellyplus1_10061cd36ce4_switch_0
      state: "off"
    - condition: state
      entity_id: binary_sensor.dream_charge_cable
      state: "on"
    - condition: state
      entity_id: input_boolean.tesla_lb_ativo
      state: "on"
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.shellyplus1_10061cd36ce4_switch_0
    - delay: "00:00:30"
    - service: number.set_value
      target:
        entity_id: number.dream_charge_current
      data:
        value: "5"
    - service: persistent_notification.create
      data:
        title: "ðŸŸ¢ Wallbox religada"
        message: "Grid estÃ¡vel. Wallbox a 5A, o LB vai ajustar automaticamente."
    - service: logbook.log
      data:
        name: "Tesla LB"
        message: "ðŸŸ¢ Wallbox religada a 5A"
